---
title: 浅谈同步、异步与阻塞、非阻塞
date: 2018-11-12 16:04:33
tags:
  - 同步
  - 异步
  - 阻塞
  - 非阻塞
categories: 
  - 程序员的自我修养
---

同步、异步与阻塞、非阻塞这四个词，程序员们都不陌生，奇怪的是，每次遇见它们，如果你翻阅资料仔细斟酌，就总会有一些新的心得体会。下面将记录一些东西帮助自己更好的理解他们，争取早日彻底吃透它们。

# 同步与异步
同步与异步这两个概念，大多数情况下同步与异步都是关注**消息通信机制** (同步通信synchronous communication/异步通信asynchronous communication)。简而言之同步与异步的区分就是看消息通知的差别。笔者建议初学者在理解同步与异步的时候不要考虑什么多线程、并发并行、阻塞非阻塞云云，我们只根据消息通信机制来区分它们！
## 概念描述
所谓同步，就是当前线程在发起一个**调用**时，没有得到结果之前，该**调用**就不返回。一旦调用返回，此线程就得到返回值了。
换句话说，就是由**调用者**主动等待这个**调用**的结果。  
而异步则是相反，**调用**在发出之后，这个**调用**就直接返回了，但并没有返回结果。换句话说，当一个异步过程调用发出后，调用者不会立刻得到结果。而是在**调用**发出后，**被调用者**通过状态、通知来通知调用者，或通过回调函数处理这个调用。（引用自知乎，作者：严肃，
[链接](https://www.zhihu.com/question/19732473/answer/20851256)）
## 场景比喻
举个例子，比如我去银行办理业务，可能会有两种方式
>1. 选择排队等候；  
>2. 另种选择取一个小纸条上面有我的号码，等到排到我这一号时由柜台的人通知我轮到我去办理业务了；  

第一种：前者(排队等候)就是同步等待消息通知，也就是我要一直在等待银行办理业务情况；  
第二种：后者(等待别人通知)就是异步等待消息通知。在异步消息处理中，等待消息通知者(在这个例子中就是等待办理业务的人)往往注册一个回调机制，在所等待的事件被触发时由触发机制(在这里是柜台的人)通过某种机制(在这里是写在小纸条上的号码，喊号)找到等待该事件的人。（引用自简书，作者：猿码道，
[链接](https://www.jianshu.com/p/aed6067eeac9)）

# 阻塞与非阻塞
阻塞和非阻塞关注的是**程序在等待调用结果（消息，返回值）时的状态**。同样的，笔者建议初学者在理解阻塞和非阻塞的时候先不要考虑多线程、并发并行什么的，我们只根据等待调用结果时的状态来区分它们！
## 概念描述 
阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。  
非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程。（引用自知乎，作者：严肃，
[链接](https://www.zhihu.com/question/19732473/answer/20851256)）  
这里说到了线程的概念，这里就简单解释一下，线程是属于进程的，进程是操作系统资源分配的基本单位，程序被装载到内存后，计算机操作系统会为这个程序建立一个运行环境，即创建了一个进程，这个进程有自己独立的代码和数据空间（程序上下文）
## 场景比喻
继续上面的那个例子，等待者除了等待消息通知之外不能做其它的事情，那么该机制就是阻塞的，表现在程序中,也就是该程序一直阻塞在该函数调用处不能继续往下执行。
相反，有的人喜欢在银行办理这些业务的时候一边玩手机聊天看视频一边等待，这样的状态就是非阻塞的，因为他(等待者)没有阻塞在这个消息通知上，而是一边做自己的事情一边等待。不论你是排队还是使用号码等待通知，只要你在等待的时候干了别的事情（比如玩手机）那你就是非阻塞机制，也就是说同步机制可以阻塞也可非阻塞的，异步也是如此。

但是需要注意了，同步非阻塞形式实际上是效率低下的，想象一下你一边看视频一边还需要抬头看到底队伍排到你了没有。如果把看视频和观察排队的位置看成是程序的两个操作的话，这个程序需要在这两种不同的行为之间来回的切换，效率可想而知是低下的；而异步非阻塞形式却没有这样的问题，因为看视频是你(等待者)的事情，而通知你则是柜台(消息触发机制)的事情，程序没有在两种不同的操作中来回切换。（引用自简书，作者：猿码道，
[链接](https://www.jianshu.com/p/aed6067eeac9)）

# 同步/异步与阻塞/非阻塞
值得注意的是当我们将同步/异步和阻塞/非阻塞这两组机制放在一起讨论的时候，通常我们都是在思考用何种机制去完成一些耗时的操作，比如本地IO读写、网络请求（Socket请求、Http请求，实质上也是IO）、数据库读写（实质上也是IO）。当我们去搜寻相关资料的过程中会发现，很多前辈都将同步异步、阻塞非阻塞与IO放在一起讨论。这篇文章很好的解决了我的疑问[关于网络IO中的同步、异步、阻塞、非阻塞](https://blog.csdn.net/suifeng3051/article/details/52779886)。

我们已知同步阻塞、同步非阻塞、异步阻塞、异步非阻塞四种状态都存在，那么它们之间到底有何不同？同步阻塞和异步非阻塞还好说，同步非阻塞和异步阻塞到底以何种方式存在？有何意义吗？
## 同步阻塞
效率低，拿上面的例子来说，就是你专心排队，什么别的事都不做。
存在方式和意义：一般情况下，Linux环境下未设置O_NONBLOCK标志位的IO读写操作（调用系统recvfrom方法）都是同步阻塞的。同步阻塞机制下的调用只有正确获取返回值程序才能继续执行，确保了任务流程的安全性。
## 异步阻塞
效率低，甚至有点蠢。
如果在银行等待办理业务的人采用的是异步的方式去等待消息被触发（通知），也就是领了一张小纸条，假如在这段时间里他不能离开银行，也不能做其它的事情，那么很显然，这个人被阻塞在了这个等待的操作上面。
>异步操作是可以被阻塞住的，只不过它不是在处理消息时阻塞，而是在等待消息通知时被阻塞。在上述例子中，假如你采用了异步阻塞机制，在通知你去办业务之前这一段时间你只能呆坐着，即一直处于阻塞状态，一旦通知消息到达，立即解除阻塞去办业务。  

存在方式和意义：实际应用中基本不会用到异步阻塞机制，因为很蠢。若是用简单回调（观察者模式）、任务队列的方法实现的异步，那么异步阻塞与同步阻塞没什么两样。倘若是用多线程的方式实现的异步，异步阻塞显得更愚蠢了，因为它完成跟同步阻塞一样的工作却多消耗一了些资源（新开了线程）。
## 同步非阻塞
实际上是效率也是很低下的。
想象一下你一边看视频一边还需要抬头看到底队伍排到你了没有，如果把打电话和观察排队的位置看成是程序的两个操作的话，这个程序需要在这两种不同的行为之间来回的切换，效率可想而知是低下的。  
存在方式和意义：最广为人知的应该就是read/write对fd设置O_NONBLOCK标志位，让读/写操作变成非阻塞的，但是还是需要当前线程频繁去确定是否完成的flag（同步消息）。
## 异步非阻塞
效率最高，也是客户端应用开发中处理耗时操作最常用的方法。
在上例中，因为看视频是你(等待者)的事情，而通知你则是柜台(消息触发机制)的事情，程序没有在两种不同的操作中来回切换。
又比如说，这个人突然发觉自己烟瘾犯了，需要出去抽根烟，于是他告诉大堂经理说，排到我这个号码的时候麻烦到外面通知我一下(注册一个回调函数)，那么他就没有被阻塞在这个等待的操作上面，自然这个就是异步+非阻塞的方式了。
存在方式和意义：异步确保了当前调用能够得到有效返回，非阻塞确保了不会在消耗时间在无意义的傻等，理论上是处理耗时操作最好的机制。当然这里只是说理论上，前提是操作系统提供相关支持、确保线程足够安全的情况下。
## 再举一个例子
对上面所讲的概念再次进行一个场景梳理，上面已经明确说明，同步/异步关注的是消息通知的机制，而阻塞/非阻塞关注的是程序（线程）等待消息通知时的状态。以小明下载文件打个比方，从这两个关注点来再次说明这两组概念，希望能够更好的促进大家的理解。
1. 同步阻塞：小明一直盯着下载进度条，到 100% 的时候就完成。
>同步体现在：等待下载完成通知；  
阻塞体现在：等待下载完成通知过程中，不能做其他任务处理；
2. 同步非阻塞：小明提交下载任务后就去干别的，每过一段时间就去瞄一眼进度条，看到 100% 就完成。
> 同步体现在：等待下载完成通知；  
非阻塞体现在：等待下载完成通知过程中，去干别的任务了，只是时不时会瞄一眼进度条；【小明必须要在两个任务间切换，关注下载进度】
3. 异步阻塞：小明换了个有下载完成通知功能的软件，下载完成就“叮”一声。不过小明仍然一直等待“叮”的声音（看起来很傻，不是吗）。
> 异步体现在：下载完成“叮”一声通知；  
阻塞体现在：等待下载完成“叮”一声通知过程中，不能做其他任务处理；
4. 异步非阻塞：仍然是那个会“叮”一声的下载软件，小明提交下载任务后就去干别的，听到“叮”的一声就知道完成了。
>异步体现在：下载完成“叮”一声通知；  
非阻塞体现在：等待下载完成“叮”一声通知过程中，去干别的任务了，只需要接收“叮”声通知即可；【软件处理下载任务，小明处理其他任务，不需关注进度，只需接收软件“叮”声通知，即可】

也就是说，同步/异步是“下载完成消息”通知的方式（机制），而阻塞/非阻塞则是在等待“下载完成消息”通知过程中的状态（能不能干其他任务），在不同的场景下，同步/异步、阻塞/非阻塞的四种组合都有应用。
所以，综上所述，同步和异步仅仅是关注的消息如何通知的机制，而阻塞与非阻塞关注的是等待消息通知时的状态。也就是说，同步的情况下，是由处理消息者自己去等待消息是否被触发，而异步的情况下是由触发机制来通知处理消息者，所以在异步机制中，处理消息者和触发机制之间就需要一个连接的桥梁：

>在银行的例子中，这个桥梁就是小纸条上面的号码。  
在小明的例子中，这个桥梁就是软件“叮”的声音。